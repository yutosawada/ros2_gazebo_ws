## SLAMによるマップ作成

以下は、シミュレーション環境上でSLAM（Simultaneous Localization and Mapping）によるマップ作成を実施する手順の詳細な説明です。

---

## 1. SLAMの概要

- **目的**  
  センサ（主にHokuyo LiDAR）やオドメトリなどのデータを用い、ロボット自身の位置推定と同時に環境の地図（マップ）を生成します。  
  これにより、ロボットは自身の位置を認識しながら未知の環境内を自律的に移動できるようになります。

- **使用するアルゴリズム例**  
  ROS1では「Gmapping」が有名ですが、ROS2では安定性や機能面から「slam_toolbox」などが広く利用されています。

---

## 2. 必要なトピックとデータ

- **LaserScanデータ**  
  URDFによりGazebo上で定義したHokuyo LiDARから取得したレーザースキャンデータ（通常 `/scan` トピック）が、周囲の障害物情報を提供します。

- **オドメトリ情報**  
  差動走行ロボットの場合、コントローラノードなどで計算されるオドメトリ（通常 `/odom` トピック）も、ロボットの移動距離や方向を補完するために使用されます。

---

## 3. シミュレーション上でのSLAM実施手順

### (1) シミュレーション環境の起動

- **Gazeboの起動**  
  事前に作成したURDFモデル（Hokuyo LiDARを含む）を利用して、Gazeboシミュレーション環境を起動します。  
  これにより、ロボットが動作する仮想環境上で、LiDARやオドメトリ情報が生成されます。

- **ロボットの操作**  
  キーボード入力（または別の操作ノード）でロボットを動かし、環境内を走行させます。  
  走行中に、センサからのリアルタイムデータがROS2トピック（例：`/scan`、`/odom`）に発行されます。

### (2) SLAMノードの起動

- **SLAMパッケージの選定**  
  ROS2では「slam_toolbox」がよく使われます。  
  slam_toolboxには、オンラインマッピング（リアルタイムでマップを生成）とオフラインマッピング（走行後にマップ生成）の両方のモードがあります。

- **起動方法の例**  
  以下のようなlaunchファイル（例：`online_async_launch.py`）を使用して、SLAMノードを起動します。  
  ※launchファイル内で、使用するセンサデータ（`/scan`）やオドメトリ（`/odom`）のトピック名、その他マッピングパラメータ（解像度、更新レート、ノイズ補正など）を適切に設定します。

  ```bash
  ros2 launch slam_toolbox online_async_launch.py use_sim_time:=true
  ```

- **動作の確認**  
  RViz2上で、SLAMノードが生成した地図（OccupancyGrid形式など）がリアルタイムに表示されることを確認します。  
  RViz2の「Map」ディスプレイに `/map` トピックを設定することで、生成されたマップを確認できます。

### (3) マップ作成プロセス

- **データ統合**  
  SLAMノードは、LiDARのLaserScanデータとオドメトリ情報を統合して、ロボットの位置推定と環境地図の更新を行います。  
  走行中、ロボットが動いた軌跡や障害物の位置が地図に反映され、どんどん環境全体のマップが生成されていきます。

- **パラメータ調整**  
  マッピングの精度や応答性は、以下のパラメータで調整可能です：  
  - **センサの更新レート**：SLAMノードの内部パラメータで、どの程度の頻度でスキャンデータを処理するか。  
  - **マップ解像度**：生成されるマップの解像度。細かすぎると計算負荷が上がり、粗すぎると精度が落ちます。  
  - **センサノイズ補正**：センサ特性に合わせたノイズモデルのパラメータ。

- **マップの保存**  
  SLAMで作成したマップは、ROS2の`nav2_map_server`パッケージの`map_saver_cli`を使用して、後で利用できるように保存することが可能です。  
  例：
  ```bash
  ros2 run nav2_map_server map_saver_cli -f my_map --ros-args -p save_map_timeout:=10000
  ```

---

## 4. まとめ

1. **シミュレーション環境の起動**  
   URDFモデルをもとにGazeboシミュレーション環境を起動し、LiDARとオドメトリデータを生成。

2. **SLAMノードの起動とデータ統合**  
   slam_toolboxなどのSLAMアルゴリズムを用いて、リアルタイムでLaserScanおよびオドメトリ情報から環境マップを生成。

3. **RViz2によるマップの可視化と保存**  
   RViz2のMapディスプレイで生成されたマップを確認し、必要に応じてmap_saver_cliで保存する。

これらのプロセスにより、シミュレーション環境上でSLAMを実施し、実際にロボットが走行する環境のマップを生成する流れが実現できます。  
参考として、QiitaやZenn上の「ROS2プログラミング基礎」シリーズなどの資料も合わせて参照すると、具体的なパラメータ調整やトラブルシュートの情報を得られます citeturn1search3.