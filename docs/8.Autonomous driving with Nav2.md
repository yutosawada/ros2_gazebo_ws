## Nav2による自律走行

以下は、Nav2を用いて自律走行を実現するための詳細な手順とポイントです。Nav2はROS2上で自律走行を実現するための統合パッケージであり、地図（/map）、自己位置推定情報（/amcl_poseなど）、およびセンサ情報（/scanなど）を用いて、グローバル・ローカルプランナーを連携させた自律走行システムを提供します。

---

## 1. Nav2の全体像と構成

- **Nav2パッケージの構成**  
  Nav2は、以下の主要コンポーネントから構成されます。
  - **Global Planner（グローバルプランナー）**  
    マップ上で目標地点までの最適経路を計画します。内部ではA*やDijkstraアルゴリズムなどが用いられることが多いです。
  - **Local Planner（ローカルプランナー）**  
    動的な障害物回避や、ロボットの運動特性に基づいて局所的な制御指令を生成します。例としてDWB（Dynamic Window Approach）などがあります。
  - **Costmap（コストマップ）**  
    マップ上に障害物情報を反映させたグリッドマップを作成し、経路計画や局所制御のための基盤となります。  
  - **Recovery Behaviors（リカバリ挙動）**  
    経路が詰まったときなどに、ロボットを安全に再配置するための処理を行います。
  - **Behavior Tree Navigator（ビヘイビアツリー）**  
    全体の動作フローを管理し、各コンポーネントを連携させるためのフレームワークです。

---

## 2. Nav2の統合と起動

### (1) 必要なパッケージのインストール・設定

- **Nav2関連パッケージのインストール**  
  ROS2のディストリビューション（例: Humble）では、Nav2パッケージ群が提供されています。  
  ```bash
  sudo apt install ros-humble-nav2-bringup ros-humble-nav2-map-server ros-humble-nav2-planner ros-humble-nav2-controller ros-humble-nav2-behavior-tree-navigator
  ```
  
- **使用するマップとセンサ情報の準備**  
  既にSLAMで生成したマップ（/mapトピック）や、AMCLなどで得られる自己位置情報（/amcl_pose）を利用するため、これらのトピックが正しく配信されていることを確認します。  
  また、Gazeboシミュレーション上ではLiDAR（/scan）やオドメトリ（/odom）も用意されている必要があります。

### (2) Nav2の起動

- **Launchファイルの利用**  
  Nav2の起動には、通常、Nav2 Bringupパッケージが提供するlaunchファイルを利用します。たとえば、シミュレーション環境での起動例は以下のようになります。
  ```bash
  ros2 launch nav2_bringup navigation_launch.py use_sim_time:=true map:=<マップファイルのパス>
  ```
  ※ launchファイル内では、グローバル・ローカルプランナーやコストマップのパラメータが設定されており、必要に応じてパラメータファイル（YAML形式）を編集して、ロボットのサイズやセンサ特性に合わせた設定に調整します。

- **パラメータ設定の例**  
  コストマップの解像度、障害物のインフレーション半径、ロボットの足回り（footprint）の形状などを設定します。  
  例：
  ```yaml
  global_costmap:
    global_frame: map
    robot_base_frame: base_link
    update_frequency: 5.0
    resolution: 0.05
    inflation_radius: 0.3
    plugins:
      - {name: static_layer, type: "nav2_costmap_2d::StaticLayer"}
      - {name: obstacle_layer, type: "nav2_costmap_2d::ObstacleLayer"}
  ```

---

## 3. 経路計画と自律走行の実現

### (1) 目標地点の設定

- **RViz2のInteractive Marker**  
  RViz2上で「2D Nav Goal」ツールを使用することで、目標地点を指定できます。  
  この操作により、目標地点が `/goal_pose` などのトピックにパブリッシュされ、Nav2のグローバルプランナーがそれを受け取ります。

### (2) 経路計画と障害物回避

- **グローバルプランナーによる経路計画**  
  指定された目標地点に向け、A*やDijkstraアルゴリズムを内部で利用し、最適な経路（グローバルプラン）が計算されます。  
  この計画結果は、コストマップを基にして障害物回避を考慮したルートとなります。

- **ローカルプランナーによる動的制御**  
  実際の走行中は、局所的な障害物（動的な人や物体など）を考慮しながら、グローバルプランに沿って速度指令を生成します。  
  ローカルプランナーは、動作環境に合わせて、障害物回避やスムーズな運動制御を実現します。

---

## 4. RViz2での自律走行結果の可視化

### (1) 必要なディスプレイの追加

- **Mapディスプレイ**  
  生成されたマップを表示し、環境全体の状況を確認します。
  
- **RobotModelディスプレイ**  
  URDFモデルに基づくロボットの現在位置と姿勢を表示します。これにより、自己位置推定結果とロボットの見た目が一致しているか確認できます。
  
- **Pose or Markerディスプレイ**  
  Nav2が算出したロボットの自己位置（`/amcl_pose`）や、グローバル経路が表示されるマーカーを追加し、目標地点からの経路や障害物回避の状況を視覚的に確認します。
  
- **Costmapディスプレイ（オプション）**  
  コストマップの状況を表示することで、障害物やインフレーション領域の設定が正しく反映されているかをチェックできます。

### (2) 操作手順

1. RViz2を起動し、Fixed Frameを「map」または「odom」に設定します。  
2. 「Add」ボタンから「Map」ディスプレイを追加し、`/map`トピックを指定。  
3. 同様に、RobotModelディスプレイを追加して、ロボットのTF情報が正しく反映されることを確認。  
4. 「2D Nav Goal」ツールを使用して、目標地点を設定。  
5. Nav2のプランナーによって生成された経路が、RViz2上に線として表示される（たとえば、コストマップの一部として）。  
6. 自己位置推定結果（/amcl_pose）も可視化し、ロボットがどの位置にいるかを確認。

---

## 5. まとめ

- **Nav2の統合と起動**  
  Nav2 Bringupパッケージを用いて、グローバルプランナー、ローカルプランナー、コストマップ、リカバリ挙動などの各コンポーネントを起動します。

- **目標設定と経路計画**  
  RViz2のツールを利用して目標地点を設定すると、Nav2がA*等のアルゴリズムを用いて経路計画を実施し、障害物回避を含む走行指令を生成します。

- **自己位置推定およびセンサ情報の統合**  
  既に生成されたマップ、AMCLによる自己位置推定、LiDARのセンサ情報を統合し、ロボットの正確な位置と経路が算出されます。

- **RViz2上での可視化**  
  Map、RobotModel、Pose、Costmapなどのディスプレイを追加することで、経路計画、自己位置、障害物の分布をリアルタイムに確認しながら自律走行の動作を検証できます。

このプロセスにより、Nav2パッケージを活用して、生成されたマップと各種センサデータから障害物回避と経路計画を実現し、目標地点まで自律走行するシステムを構築できます。

参考資料として、ROS2 Navigation2の公式ドキュメントやQiita、Zenn上のナビゲーション関連記事が有用です citeturn1search3.